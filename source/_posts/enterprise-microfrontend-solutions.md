---
title: 企业级微前端解决方案
author: Kq
date: 2019-12-14 10:20:18
categories:
tags:
  - microfrontend
  - 微前端
  - 架构
---

## 什么是微前端

最近业界越来越关注复杂的现代化 Web 开发需要怎样的整体架构和组织结构这个问题。于是我们开始看到单体前端正在分解为更小、更简单的模块，这些模块可以各自独立开发、测试和部署，而它们组合在一起仍然对客户表现为一件单一完整的产品。[1]

> 微前端是一种架构风格，其中众多独立交付的前端应用组合成一个大型整体。

这是个过程解耦与结果聚合的过程，我把它概括为：

- 代码解耦，应用聚合；
- 功能解耦，产品聚合；
- 开发解耦，交付聚合；
- 项目解耦，运营聚合。

ThoughtWorks Technology Rader 从 2016.11 期开始，将微前端列入“ACCESS”之列，随后又列入“TRIAL”阶段，在最新的 2019.4 期中，微前端技术已然成为“ADOPT”阶段的一员，发展极其迅速。发展至今，国内很多大厂都先后出现企业级微前端解决方案和落地实践。[2]

## 微前端技术优势

传统 SPA 开发模式，发展至今面临的问题：

- 随着产品迭代，发展到一定程度，容易成为巨石应用
- 技术栈不断升级、变迁，多框架多版本、同框架多版本共存的情况难以避免
- 跨团队合作开发困难

微前端架构的优势：

- 独立开发(技术栈无关)
- 独立部署
- 独立运行

微前端应运而生，可以对项目进行合理拆分、组合，以解决大型项目解耦和多版本共存的问题。[3]

## 微前端解决方案

## 大厂企业级解决方案

### 网易严选

在网易严选，微前端不仅仅是一个框架或者说一层外壳，而是一整套包括规范、工具、框架、配置中心、应用监控等一系列相关功能在内的前端应用架构体系。根据不同的需求和应用场景，针对性地做一个个性化开发和改造，从而在业务场景中提高生产力。

![网易严选微前端总体架构图](/images/网易严选微前端总体架构图.png)

网易严选微前端架构技术特点：

1. 应用开发链路闭环
   - 基于 webpack 构建，配置 webpackJsonp
   - 严选前端应用包含前端和 Node（用于承担 BFF 层和 SSR 等功能）
2. 主框架关键技术点
   - 基于 single-spa
   - 借助 Node 层作为支撑

网易严选的微前端方案，在 Single-SPA 的思想上进行了大刀阔斧的改革和创新，同时借助 Node 层（数据层、服务端渲染、静态资源处理）来作为支撑，可以说形成了一个较有特色的微前端应用体系。

- 独立开发、部署、运行
- 技术栈无关
- 应用自由拆解和组合，子应用复用性强
- 配套的 Node 层设计，使用前端+服务端作为整体方案，子应用即可独立提供服务，亦可作为主应用的一个模块
- 业务代码无入侵设计，子应用免主动式申请声明周期
- 子应用间实现绝对隔离
- 项目改造成本低，老项目能尽快落地

运行时加载与路由策略：

1. 浏览器访问 `/main/app1/#/users`
2. 加载主应用 `main`
3. 主应用获取应用名称 `app1`
4. 请求 app1 的配置(`/main/app1/config/get.json`)
5. 加载 app1 子应用静态配置
6. 渲染 app1 子应用
7. app1 子应用接管路由，相应路由变化
8. app1 加载 `/users` 对应的页面

<!-- ![网易严选微前端加载流程图](/images/网易严选微前端加载流程图.png) -->

几个注意点：

- 主应用的作用
  - 页面主题框架的渲染
  - 监听捕获全局路由的变化，加载/卸载子应用，active 标签等
  - 应用隔离、应用通信、数据共享等全局方法的载体
- 子应用在启动后，会接管系统的路由体系，与一个独立运行的应用无差
- 在整套微前端应用框架体系中，遵循「约定优于配置」

应用隔离：

- 一个子应用从加载到运行，再到卸载，有可能会对全局变量产生污染，这些污染包括但不限于：
  - 添加/删除/修改全局变量 (比如：`window.$ = jQuery`)
  - 绑定全局事件 (比如：`window.addEventListener('popstate', cb)`)
  - 修改原生方法或对象 (比如：`Promise`)
  - 修改原生方法或对象的原型链 (比如：`XMLHttpRequest.prototype.open`)
- 硬隔离：每次切换应用使用 `window.reload`
  - 前端 snapshot + resume，快速恢复应用页面（已应用于生成）
  - 主应用使用 SSR 局部直出（未应用）
- 软隔离：应用加载前做全局快照，应用卸载后恢复全局属性
  - 

## 参考文章

1. [大前端时代下的微前端架构：实现增量升级、代码解耦、独立部署](https://www.infoq.cn/article/03*BeU3zQegIbIytRsX9)
2. [Techniques Micro frontends](https://www.thoughtworks.com/radar/techniques/micro-frontends)
3. [网易严选企业级微前端解决方案与落地实践](https://mp.weixin.qq.com/s/x2N-Y5xZV-XbrqxDT_wLKA)
4. [可能是你见过最完善的微前端解决方案](https://zhuanlan.zhihu.com/p/78362028)
5. [面向大型工作台的微前端解决方案 icestark](https://zhuanlan.zhihu.com/p/88449415)
6. [实施前端微服务化的六七种方式](https://zhuanlan.zhihu.com/p/39102712)
7. [网易云控制台微前端探索实践](https://zhuanlan.zhihu.com/p/78152485)
8. [每日优鲜供应链前端团队微前端改造](https://juejin.im/post/5d7f702ce51d4561f777e258)
9. [UCF-Web 整体架构设计和介绍](https://www.yuque.com/ucf-web/book/ct51hg)
10. [微前端的核心价值](https://zhuanlan.zhihu.com/p/95085796)
11. [微前端的那些事儿](https://microfrontends.cn/)
